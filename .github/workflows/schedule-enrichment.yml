name: Run Refresh Enriched Customers Cache

on:
  workflow_dispatch:  # ÙŠØ³Ù…Ø­ Ø¨ØªØ´ØºÙŠÙ„Ù‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§
  schedule:
    - cron: '0 2 * * *'  # ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ù‹Ø§ UTC (5 ØµØ¨Ø§Ø­Ù‹Ø§ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†)

jobs:
  refresh-enriched-cache:
    runs-on: ubuntu-latest
    steps:
      - name: Call refresh_enriched_customers_cache SQL function and print result
        run: |
          echo "ðŸ“¡ Calling Supabase RPC: refresh_enriched_customers_cache"
          RESPONSE=$(curl -s -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/rpc/refresh_enriched_customers_cache" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            --data '{}')

          echo "âœ… Enriched Cache Refresh Result:"
          echo "$RESPONSE"
