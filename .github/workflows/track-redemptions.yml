name: Track Redemptions

on:
  schedule:
    - cron: '0 * * * *'  # ÙŠØ´ØºÙ„Ù‡Ø§ ÙƒÙ„ Ø³Ø§Ø¹Ø©
  workflow_dispatch:      # Ù„ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù…Ù† GitHub UI

jobs:
  call-function:
    runs-on: ubuntu-latest
    steps:
      - name: Call Supabase Edge Function
        run: |
          echo "ğŸ“¡ Calling Supabase function: track-redemptions..."

          response=$(curl -s -X POST https://qwaooajgkkqtpbidzumd.supabase.co/functions/v1/track-redemptions \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")

          echo "------ Function Response ------"
          echo "$response"
          echo "-------------------------------"

          success=$(echo "$response" | jq -r '.success // empty')
          updated=$(echo "$response" | jq -r '.updated // 0')

          if [[ "$success" == "true" ]]; then
            echo "âœ… Redemption tracking completed successfully."
            echo "ğŸ”„ Records updated: $updated"
          else
            echo "âŒ Error during redemption tracking:"
            echo "$response"
            exit 1
          fi
